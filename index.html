<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì±…ë°”ì˜ ì„œì¬</title>

  <!-- React / ReactDOM / Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const HERO_IMG = "./hero.webp";
    const norm = (s) => (s || "").toString().trim().toLowerCase();

    // ì½”ë©˜íŠ¸ ë¡œì»¬ ì €ì¥
    function useLocalStorage(key, initial) {
      const [value, setValue] = useState(() => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : initial;
        } catch {
          return initial;
        }
      });

      const set = (v) => {
        const val = typeof v === "function" ? v(value) : v;
        setValue(val);
        try {
          localStorage.setItem(key, JSON.stringify(val));
        } catch {}
      };

      return [value, set];
    }

    function Header({ keyword, setKeyword }) {
      return (
        <header className="w-full bg-white/90 backdrop-blur border-b sticky top-0 z-20">
          <div className="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <span className="text-xl md:text-2xl font-bold">ğŸ“– ì±…ë°”ì˜ ì„œì¬</span>
            </div>
            <a
              href="/admin"
              className="text-[11px] text-gray-400 hover:text-gray-800 underline"
            >
              ê´€ë¦¬ì
            </a>
          </div>
          <div className="max-w-3xl mx-auto px-4 pb-3">
            <input
              type="search"
              placeholder="ì±… ì œëª© ë˜ëŠ” ì‘ê°€ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”."
              className="w-full h-11 px-4 rounded-2xl border border-gray-200 shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-gray-900"
              value={keyword}
              onChange={(e) => setKeyword(e.target.value)}
            />
          </div>
        </header>
      );
    }

    function Promo() {
      return (
        <section className="w-full mt-4 flex flex-col items-center">
          <div className="w-full max-w-xs sm:max-w-sm px-4">
            <img
              src={HERO_IMG}
              alt="ì±…ë°” í™ë³´ ì´ë¯¸ì§€"
              className="w-full h-auto object-contain rounded-2xl shadow-md"
            />
          </div>
          <p className="mt-3 text-xs text-gray-600 text-center italic">
            ë°” í…Œì´ë¸”ì— ìƒ˜í”Œì´ ìˆìŠµë‹ˆë‹¤. í¸í•˜ê²Œ ê³¨ë¼ ì½ì–´ë³´ì„¸ìš”.
          </p>
        </section>
      );
    }

    function BookTable({ books, keyword }) {
      const q = norm(keyword);
      // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì•„ì˜ˆ ì•„ë¬´ê²ƒë„ ê·¸ë¦¬ì§€ ì•ŠìŒ
      if (!q) return null;

      const filtered = books.filter((b) =>
        (norm(b.title) + " " + norm(b.author)).includes(q)
      );

      return (
        <section className="max-w-3xl mx-auto px-4 mt-5">
          <div className="flex justify-between items-center mb-2 text-xs text-gray-500">
            <span>ì´ {books.length}ê¶Œ ì¤‘ ê²€ìƒ‰</span>
            <span>ê²€ìƒ‰ ê²°ê³¼ {filtered.length}ê¶Œ</span>
          </div>
          <div className="overflow-x-auto bg-white rounded-2xl shadow-sm border border-gray-100">
            <table className="w-full text-left text-sm">
              <thead className="bg-gray-50 text-gray-600 text-xs">
                <tr>
                  <th className="px-3 py-2 w-1/2">ì´ë¦„</th>
                  <th className="px-3 py-2 w-1/4">ì €ì</th>
                  <th className="px-3 py-2 w-1/4">ìœ„ì¹˜</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((b) => (
                  <tr
                    key={b.id}
                    className="border-t border-gray-100 hover:bg-gray-50"
                  >
                    <td className="px-3 py-2 align-top">{b.title}</td>
                    <td className="px-3 py-2 align-top text-gray-700">
                      {b.author}
                    </td>
                    <td className="px-3 py-2 align-top text-gray-600 text-xs">
                      {b.location}
                    </td>
                  </tr>
                ))}
                {filtered.length === 0 && (
                  <tr>
                    <td
                      colSpan={3}
                      className="px-3 py-6 text-center text-xs text-gray-400"
                    >
                      ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      );
    }

    function CommentBox({ onAdd }) {
      const [text, setText] = useState("");

      const submit = () => {
        if (!text.trim()) return;
        onAdd(text.trim());
        setText("");
        alert("ì½”ë©˜íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë°”ì—ì„œë§Œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      };

      return (
        <section className="max-w-3xl mx-auto px-4 mt-7 mb-6">
          <h2 className="text-sm font-semibold mb-2">
            ğŸ’¬ ì±… ì¶”ì²œ / ì±…ë°”ì— ëŒ€í•œ ì½”ë©˜íŠ¸
          </h2>
          <textarea
            className="w-full border border-gray-200 rounded-xl p-3 text-sm min-h-[90px] resize-none focus:outline-none focus:ring-2 focus:ring-gray-900"
            placeholder="ìµëª…ìœ¼ë¡œ ì±… ì¶”ì²œ ë˜ëŠ” ì±…ë°”ì— ëŒ€í•œ ì´ì•¼ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”."
            value={text}
            onChange={(e) => setText(e.target.value)}
          />
          <div className="flex justify-end mt-2">
            <button
              onClick={submit}
              className="px-4 py-2 rounded-full bg-gray-900 text-white text-xs font-medium hover:bg-black"
            >
              ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸°
            </button>
          </div>
          <p className="mt-1 text-[11px] text-gray-500">
            ì‘ì„±ëœ ì½”ë©˜íŠ¸ëŠ” í™”ë©´ì—ëŠ” í‘œì‹œë˜ì§€ ì•Šê³ , ë°”ì—ì„œë§Œ ë”°ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
          </p>
        </section>
      );
    }

    function App() {
      const [books, setBooks] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [keyword, setKeyword] = useState("");
      const [comments, setComments] = useLocalStorage("chaegbar_comments", []);

      useEffect(() => {
        async function load() {
          try {
            const res = await fetch("./data/books.json?cachebust=" + Date.now(), {
              cache: "no-store",
            });
            if (!res.ok) throw new Error("failed");
            const json = await res.json();
            const arr = Array.isArray(json)
              ? json
              : Array.isArray(json.books)
              ? json.books
              : [];
            setBooks(arr);
          } catch (e) {
            console.error(e);
            setError("ì±… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          } finally {
            setLoading(false);
          }
        }
        load();
      }, []);

      const addComment = (text) => {
        const c = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
          text,
          createdAt: new Date().toISOString(),
        };
        setComments((prev) => [...prev, c]);
      };

      return (
        <div className="min-h-screen flex flex-col">
          <Header keyword={keyword} setKeyword={setKeyword} />

          <main className="flex-1 pb-6">
            <Promo />

            {loading && (
              <p className="max-w-3xl mx-auto px-4 mt-4 text-xs text-gray-500">
                ì±… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
              </p>
            )}

            {!loading && error && (
              <p className="max-w-3xl mx-auto px-4 mt-4 text-xs text-red-500">
                {error}
              </p>
            )}

            {/* âœ… ê²€ìƒ‰ì–´ê°€ ìˆì„ ë•Œë§Œ í…Œì´ë¸” ì¶œë ¥ */}
            {!loading && !error && (
              <BookTable books={books} keyword={keyword} />
            )}

            <CommentBox onAdd={addComment} />
          </main>

          <footer className="text-center text-[11px] text-gray-400 pb-4">
            Â© 2025 ì±…ë°”ì˜ ì„œì¬
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", user => {
      if (!user) {
        window.netlifyIdentity.on("login", () => {
          window.location.href = "/admin/";
        });
      }
    });
  }
</script>
</body>
</html>
